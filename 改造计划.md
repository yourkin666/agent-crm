# CRM 系统表结构统一改造计划

## 📋 改造概述

**目标**：统一客户管理页面和预约带看页面的带看记录数据结构，删除 `appointments` 表，统一使用 `viewing_records` 表。

**原因**：

- 避免数据重复和不一致
- 简化业务逻辑
- 提高数据维护效率
- 消除两个页面之间的数据孤岛

## 📊 当前状况分析

### 现有表结构对比

| 字段             | appointments 表 | viewing_records 表     | 是否需要迁移                |
| ---------------- | --------------- | ---------------------- | --------------------------- |
| id               | ✅ 主键         | ✅ 主键                | ⚠️ 需处理 ID 冲突           |
| customer_name    | ✅ 客户姓名     | ❌ 缺失                | 🔄 **需要添加**             |
| customer_phone   | ✅ 客户电话     | ❌ 缺失                | 🔄 **需要添加**             |
| property_name    | ✅ 物业名称     | ✅ 带看楼盘            | ✅ 字段匹配                 |
| property_address | ✅ 房间地址     | ✅ 楼盘地址            | ✅ 字段匹配                 |
| agent_name       | ✅ 经纪人       | ✅ viewer_name         | ✅ 语义匹配                 |
| appointment_time | ✅ 预约时间     | ✅ viewing_time        | ✅ 语义匹配                 |
| status           | ✅ 状态(1-5)    | ✅ viewing_status(1-4) | ✅ 保持 viewing_status 定义 |
| type             | ✅ 类型         | ✅ business_type       | ✅ 字段匹配                 |
| city             | ✅ 城市         | ❌ 缺失                | 不需要                      |
| is_converted     | ✅ 是否转换     | ❌ 不需要              | ❌ 删除字段                 |
| remark           | ❌ 缺失         | ✅ notes               | ✅ **需要添加**             |
| customer_id      | ❌ 缺失         | ✅ 外键                | ✅ 保留关联                 |
| room_type        | ❌ 缺失         | ✅ 带看户型            | ✅ 保留专业字段             |
| commission       | ❌ 缺失         | ✅ 带看佣金            | ✅ 保留业务字段             |

### 数据量统计

- **appointments 表**：5 条记录
- **viewing_records 表**：26 条记录
- **总计需要迁移**：5 条记录

## 🔧 改造方案

### 阶段一：数据库结构调整

#### 1.1 修改 viewing_records 表结构

```sql
-- 添加新字段
ALTER TABLE viewing_records ADD COLUMN customer_name TEXT DEFAULT '';
ALTER TABLE viewing_records ADD COLUMN customer_phone TEXT DEFAULT '';

-- 重命名字段以保持一致性（可选）
-- 注意：SQLite不支持直接重命名列，需要通过重建表的方式
```

#### 1.2 创建数据迁移脚本

```sql
-- 将 appointments 表数据迁移到 viewing_records 表
INSERT INTO viewing_records (
    customer_name,
    customer_phone,
    viewing_time,
    property_name,
    property_address,
    viewer_name,
    viewing_status,
    business_type,
    notes,
    created_at,
    updated_at
)
SELECT
    customer_name,
    customer_phone,
    appointment_time,
    property_name,
    property_address,
    agent_name,
    1 as viewing_status,  -- 统一设置为1=待确认，保持viewing_status原有定义
    type,
    '从预约记录迁移',
    created_at,
    updated_at
FROM appointments;
```

#### 1.3 删除 appointments 表

```sql
-- 删除相关索引和触发器
DROP INDEX IF EXISTS idx_appointments_customer_phone;
DROP INDEX IF EXISTS idx_appointments_status;
DROP INDEX IF EXISTS idx_appointments_appointment_time;
DROP INDEX IF EXISTS idx_appointments_city;
DROP INDEX IF EXISTS idx_appointments_is_converted;
DROP TRIGGER IF EXISTS update_appointments_updated_at;

-- 删除表
DROP TABLE appointments;
```

### 阶段二：代码结构调整

#### 2.1 需要修改的 API 路由

1. **`/api/appointments/route.ts`**

   - 🔄 重构 GET 方法：直接查询 viewing_records 表
   - 🔄 重构 POST 方法：直接插入 viewing_records 表
   - ❌ 删除复杂的 UNION 查询逻辑

2. **`/api/appointments/[id]/route.ts`**

   - 🔄 简化 GET 方法：直接查询 viewing_records
   - 🔄 简化 PUT 方法：直接更新 viewing_records
   - ❌ 删除 ID 偏移逻辑(+10000)

3. **`/api/appointments/[id]/complete/route.ts`**

   - 🔄 修改为更新 viewing_records 表
   - 🔄 保持 viewing_status 状态定义（4=已带看）

4. **`/api/appointments/[id]/cancel/route.ts`**

   - 🔄 修改为更新 viewing_records 表

5. **`/api/external/appointments/route.ts`**

   - 🔄 修改为插入 viewing_records 表

6. **`/api/sync-data/route.ts`**
   - ❌ 删除 appointments 相关同步逻辑

#### 2.2 需要修改的前端组件

1. **`/components/appointments/`目录下的组件**

   - `AddAppointmentModal.tsx` - 🔄 调整字段映射
   - `EditAppointmentModal.tsx` - 🔄 调整字段映射

2. **`/app/appointments/page.tsx`**
   - 🔄 调整 API 调用路径
   - 🔄 更新数据结构处理
   - 🔄 调整列表显示逻辑

#### 2.3 需要修改的类型定义

1. **`/types/index.ts`**

   - ❌ 删除 `Appointment` 类型
   - ❌ 删除 `AppointmentStatus` 枚举
   - ❌ 删除 `AppointmentFilterParams` 类型
   - 🔄 扩展 `ViewingRecord` 类型添加新字段

2. **`/utils/constants.ts`**
   - ❌ 删除 `APPOINTMENT_STATUS_*` 常量
   - 🔄 确保 `VIEWING_STATUS_*` 常量完整

### 阶段三：数据验证和测试

#### 3.1 数据迁移验证

- [ ] 验证所有 appointments 数据已正确迁移
- [ ] 验证字段映射正确性
- [ ] 验证状态统一为待确认正确性
- [ ] 验证时间字段格式

#### 3.2 功能测试

- [ ] 预约带看页面 CRUD 操作
- [ ] 客户管理页面带看记录操作
- [ ] 数据联动和一致性
- [ ] 筛选和搜索功能
- [ ] 分页功能

## 📅 实施时间表

| 阶段     | 任务               | 预计时间        | 优先级 |
| -------- | ------------------ | --------------- | ------ |
| 1        | 数据库 schema 更新 | 30 分钟         | 🔴 高  |
| 2        | 数据迁移脚本       | 20 分钟         | 🔴 高  |
| 3        | API 路由重构       | 2 小时          | 🔴 高  |
| 4        | 前端组件调整       | 1.5 小时        | 🟡 中  |
| 5        | 类型定义更新       | 30 分钟         | 🟡 中  |
| 6        | 测试验证           | 1 小时          | 🟢 低  |
| **总计** |                    | **约 5.5 小时** |        |

## ⚠️ 风险和注意事项

### 数据风险

1. **数据丢失风险**：迁移前必须备份数据库
2. **ID 冲突风险**：viewing_records 可能与 appointments 有 ID 重叠
3. **状态统一风险**：appointments 的状态将统一设为待确认，需要后续手动调整

### 功能风险

1. **API 兼容性**：现有前端代码依赖 appointments API
2. **字段缺失**：某些 appointments 字段在 viewing_records 中不存在
3. **业务逻辑**：两个页面的业务逻辑可能有差异

### 减少风险的措施

1. **分步实施**：按阶段逐步进行，每步验证
2. **数据备份**：实施前完整备份数据库
3. **回滚方案**：准备快速回滚脚本
4. **测试优先**：在测试环境完整验证后再上线

## 🎯 预期收益

### 技术收益

- ✅ 消除数据冗余
- ✅ 简化数据库结构
- ✅ 减少代码复杂度
- ✅ 提高查询性能

### 业务收益

- ✅ 数据一致性保证
- ✅ 减少维护成本
- ✅ 改善用户体验
- ✅ 便于功能扩展

## 📝 实施检查清单

### 准备阶段

- [ ] 备份当前数据库
- [ ] 准备测试数据
- [ ] 设置测试环境

### 实施阶段

- [ ] 执行数据库 schema 更新
- [ ] 执行数据迁移脚本
- [ ] 验证数据迁移结果
- [ ] 更新 API 路由代码
- [ ] 更新前端组件代码
- [ ] 更新类型定义

### 验证阶段

- [ ] 功能测试通过
- [ ] 性能测试通过
- [ ] 数据一致性验证
- [ ] 用户验收测试

### 清理阶段

- [ ] 删除旧的 appointments 相关代码
- [ ] 更新文档
- [ ] 清理无用文件

---

**创建时间**：2025 年 8 月 6 日  
**创建人**：系统管理员  
**状态**：待实施
