# 外部统计接口修改计划

## 📋 需求概述

为外部统计接口 `/api/external/statistics` 添加两个新的查询参数：

- `userId`：客户 ID，支持批量查询（多个 ID 用逗号分隔）
- `botId`：托管 ID，支持批量查询（多个 ID 用逗号分隔）

## 🎯 功能需求

### 1. 参数支持

- 支持单个或多个 `userId` 参数查询
- 支持单个或多个 `botId` 参数查询
- 参数格式：`userId=123,456,789` 或 `botId=bot1,bot2,bot3`
- 如果不传这两个参数，则查询所有客户的数据（保持原有行为）

### 2. 查询逻辑

- 根据传入的 `userId` 和 `botId` 参数，在客户表和带看记录表中筛选对应的数据
- 统计四个指标：
  - `viewing_count`：约看数量（指定客户/托管的带看记录数）
  - `completed_unpaid_count`：已成交未结佣客户数（指定客户/托管的客户状态为 4 的总数）
  - `completed_paid_count`：已成交已结佣客户数（指定客户/托管的客户状态为 5 的总数）
  - `total_commission`：佣金总金额（指定客户/托管的佣金总和）

### 3. 时间筛选

- 保持原有的 `date_from` 和 `date_to` 参数功能
- 时间筛选与客户/托管筛选可以组合使用

## 🔧 技术实现方案

### 1. 参数解析和验证

```typescript
// 解析批量参数
function parseBatchParams(param: string | null): string[] {
  if (!param) return [];
  return param
    .split(",")
    .map((id) => id.trim())
    .filter((id) => id.length > 0);
}

// 验证参数格式
function validateBatchParams(userIds: string[], botIds: string[]): boolean {
  // 验证ID格式（根据实际业务需求定义）
  return true;
}
```

### 2. SQL 查询修改

需要修改两个主要查询：

#### 2.1 带看记录统计查询

```sql
-- 原有查询（无筛选）
SELECT
  COUNT(*) as viewing_count,
  COALESCE(SUM(commission), 0) as total_commission
FROM qft_ai_viewing_records
WHERE DATE(created_at) BETWEEN ? AND ?

-- 修改后查询（添加客户/托管筛选）
SELECT
  COUNT(*) as viewing_count,
  COALESCE(SUM(commission), 0) as total_commission
FROM qft_ai_viewing_records vr
LEFT JOIN qft_ai_customers c ON vr.customer_id = c.id
WHERE DATE(vr.created_at) BETWEEN ? AND ?
  AND (c.userId IN (?) OR c.botId IN (?))
```

#### 2.2 客户状态统计查询

```sql
-- 原有查询（无筛选）
SELECT
  SUM(CASE WHEN status = 4 THEN 1 ELSE 0 END) as completed_unpaid_count,
  SUM(CASE WHEN status = 5 THEN 1 ELSE 0 END) as completed_paid_count
FROM qft_ai_customers

-- 修改后查询（添加客户/托管筛选）
SELECT
  SUM(CASE WHEN status = 4 THEN 1 ELSE 0 END) as completed_unpaid_count,
  SUM(CASE WHEN status = 5 THEN 1 ELSE 0 END) as completed_paid_count
FROM qft_ai_customers
WHERE userId IN (?) OR botId IN (?)
```

### 3. 接口响应增强

在响应中添加筛选条件信息：

```json
{
  "success": true,
  "data": {
    "viewing_count": 150,
    "completed_unpaid_count": 25,
    "completed_paid_count": 10,
    "total_commission": 125000.0,
    "period": {
      "date_from": "2024-01-01",
      "date_to": "2024-01-31"
    },
    "filters": {
      "userIds": ["123", "456", "789"],
      "botIds": ["bot1", "bot2"]
    }
  },
  "message": "统计数据获取成功"
}
```

## 📝 修改步骤

### 步骤 1：修改接口参数处理

- 在 `GET` 函数中添加 `userId` 和 `botId` 参数解析
- 添加参数验证逻辑
- 更新日志记录

### 步骤 2：修改 `getStatistics` 函数

- 添加 `userIds` 和 `botIds` 参数
- 修改 SQL 查询逻辑，支持客户/托管筛选
- 处理空参数的情况（查询所有数据）

### 步骤 3：更新 SQL 查询

- 修改带看记录统计查询，添加 JOIN 和 WHERE 条件
- 修改客户状态统计查询，添加 WHERE 条件
- 处理参数为空的情况

### 步骤 4：增强响应数据

- 在响应中添加 `filters` 字段，显示当前使用的筛选条件
- 更新接口文档

### 步骤 5：测试验证

- 测试单个参数查询
- 测试批量参数查询
- 测试参数组合查询
- 测试无参数查询（保持原有行为）
- 测试错误参数处理

## 🧪 测试用例

### 测试用例 1：单个 userId 查询

```
GET /api/external/statistics?userId=123
```

### 测试用例 2：批量 userId 查询

```
GET /api/external/statistics?userId=123,456,789
```

### 测试用例 3：单个 botId 查询

```
GET /api/external/statistics?botId=bot1
```

### 测试用例 4：批量 botId 查询

```
GET /api/external/statistics?botId=bot1,bot2,bot3
```

### 测试用例 5：组合查询

```
GET /api/external/statistics?userId=123,456&botId=bot1&date_from=2024-01-01&date_to=2024-01-31
```

### 测试用例 6：无参数查询（保持原有行为）

```
GET /api/external/statistics
```

## 📚 文档更新

### 1. 接口文档更新

- 在 `docs/外部统计接口文档.md` 中添加新参数说明
- 更新请求参数表格
- 添加新的使用示例
- 更新响应字段说明

### 2. 代码注释更新

- 为新增的函数添加详细注释
- 更新现有函数的注释

## ⚠️ 注意事项

### 1. 性能考虑

- 批量参数查询可能影响性能，需要监控查询时间
- 考虑添加参数数量限制（如最多支持 100 个 ID）
- 确保数据库索引支持新的查询条件

### 2. 兼容性

- 保持向后兼容，不传新参数时行为不变
- 确保现有调用不受影响

### 3. 错误处理

- 添加参数格式验证
- 处理无效的 ID 参数
- 提供清晰的错误信息

### 4. 日志记录

- 记录筛选条件信息
- 记录查询性能数据
- 便于问题排查和监控

## 🎯 预期效果

修改完成后，接口将支持：

1. 根据指定客户 ID 查询统计数据
2. 根据指定托管 ID 查询统计数据
3. 支持批量 ID 查询
4. 与时间筛选参数组合使用
5. 保持原有功能的完整性
6. 提供清晰的筛选条件反馈
