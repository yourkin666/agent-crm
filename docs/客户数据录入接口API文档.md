# å®¢æˆ·æ•°æ®å½•å…¥æ¥å£ API æ–‡æ¡£

> æ–‡æ¡£æ›´æ–°æ—¶é—´ï¼š2025-01-27  
> æ¥å£ç‰ˆæœ¬ï¼šv2.0  
> é€‚ç”¨äºï¼šå¤–éƒ¨ç³»ç»Ÿå®¢æˆ·æ•°æ®é›†æˆ  
> åŸºç¡€ URLï¼š`https://your-domain.com/api/external`

---

## ğŸ“‹ æ¥å£æ¦‚è§ˆ

å®¢æˆ·æ•°æ®å½•å…¥æ¥å£ç”¨äºå¤–éƒ¨ç³»ç»Ÿå‘ CRM ç³»ç»Ÿå½•å…¥æˆ–æ›´æ–°å®¢æˆ·ä¿¡æ¯ã€‚è¯¥æ¥å£æ”¯æŒå¹‚ç­‰æ€§æ“ä½œï¼Œç›¸åŒ userId çš„é‡å¤è°ƒç”¨ä¼šè‡ªåŠ¨æ›´æ–°ç°æœ‰å®¢æˆ·ä¿¡æ¯ã€‚

- **æ¥å£åœ°å€**: `POST /api/external/customers`
- **åŠŸèƒ½æè¿°**: æ ¹æ® userId å½•å…¥æˆ–æ›´æ–°å®¢æˆ·ä¿¡æ¯
- **å¹‚ç­‰æ€§**: âœ… æ”¯æŒé‡å¤è°ƒç”¨
- **è¿”å›æ ¼å¼**: JSON

---

### è¯·æ±‚å¤´è¦æ±‚

```
Content-Type: application/json
User-Agent: Your-System-Name/1.0
```

### é”™è¯¯å¤„ç†

æ¥å£éµå¾ªç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼ï¼š

```json
{
  "success": false,
  "error": "é”™è¯¯æè¿°",
  "message": "é”™è¯¯ä¿¡æ¯"
}
```

---

## ğŸ“ è¯·æ±‚å‚æ•°

### è¯·æ±‚ä½“å‚æ•°

| å‚æ•°å           | ç±»å‹   | å¿…å¡« | é»˜è®¤å€¼        | è¯´æ˜                                                                            |
| ---------------- | ------ | ---- | ------------- | ------------------------------------------------------------------------------- |
| **åŸºç¡€ä¿¡æ¯**     |
| `userId`         | string | âœ…   | -             | ç”¨æˆ·ç¬¬ä¸‰æ–¹å”¯ä¸€æ ‡è¯† ID                                                           |
| `botId`          | string | âŒ   | -             | æœºå™¨äºº/å·¥ä½œäººå‘˜è´¦å· ID                                                          |
| `nickname`       | string | âŒ   | -             | å®¢æˆ·æ˜µç§°                                                                        |
| `name`           | string | âŒ   | -             | å®¢æˆ·çœŸå®å§“å                                                                    |
| `phone`          | string | âŒ   | -             | ä¸»æ‰‹æœºå·ï¼ˆæ ¼å¼ï¼š1[3-9]xxxxxxxxï¼‰                                                |
| `backup_phone`   | string | âŒ   | -             | å¤‡ç”¨æ‰‹æœºå·                                                                      |
| `wechat`         | string | âŒ   | -             | å¾®ä¿¡å·                                                                          |
| **ä¸šåŠ¡ä¿¡æ¯**     |
| `status`         | number | âŒ   | 1             | å®¢æˆ·çŠ¶æ€ï¼ˆ1-5ï¼šè·Ÿè¿›ä¸­/ä¸å†å›å¤/å·²çº¦å¸¦çœ‹/å·²æˆäº¤æœªç»“ä½£/å·²æˆäº¤å·²ç»“ä½£ï¼‰             |
| `community`      | string | âŒ   | -             | å’¨è¯¢å°åŒºåç§°                                                                    |
| `business_type`  | string | âŒ   | 'whole_rent'  | ä¸šåŠ¡ç±»å‹ï¼ˆwhole_rent/shared_rent/centralizedï¼‰                                  |
| `room_type`      | string | âŒ   | 'one_bedroom' | æˆ¿å‹ï¼ˆone_bedroom/two_bedroom/three_bedroom/four_plus/master_room/second_roomï¼‰ |
| `room_tags`      | string | âŒ   | -             | æˆ¿å‹æ ‡ç­¾ï¼ˆJSON æ ¼å¼æ•°ç»„å­—ç¬¦ä¸²ï¼‰                                                 |
| `move_in_date`   | string | âŒ   | -             | æœŸæœ›å…¥ä½æ—¶é—´ï¼ˆYYYY-MM-DD æ ¼å¼ï¼‰                                                 |
| `lease_period`   | number | âŒ   | -             | ç§Ÿèµå‘¨æœŸï¼ˆæœˆæ•°ï¼‰                                                                |
| `price_range`    | string | âŒ   | -             | å¯æ¥å—ä»·æ ¼èŒƒå›´ï¼ˆå¦‚ï¼š"5000-7000"ï¼‰                                               |
| `source_channel` | string | âŒ   | 'referral'    | æ¥æºæ¸ é“ï¼ˆxianyu/xiaohongshu/beike/58tongcheng/shipinhao/douyin/referralï¼‰      |
| `creator`        | string | âŒ   | 'å¤–éƒ¨ç³»ç»Ÿ'    | å½•å…¥äººæ ‡è¯†                                                                      |
| `internal_notes` | string | âŒ   | -             | å†…éƒ¨å¤‡æ³¨                                                                        |

---

## ğŸ“Š å­—æ®µçŠ¶æ€è¯´æ˜

### å®¢æˆ·çŠ¶æ€ (status)

| çŠ¶æ€å€¼ | çŠ¶æ€åç§°     | è¯´æ˜               |
| ------ | ------------ | ------------------ |
| 1      | è·Ÿè¿›ä¸­       | å®¢æˆ·æ­£åœ¨è·Ÿè¿›ä¸­     |
| 2      | å®¢æˆ·ä¸å†å›å¤ | å®¢æˆ·åœæ­¢å›å¤       |
| 3      | å·²çº¦å¸¦çœ‹     | å·²é¢„çº¦å¸¦çœ‹æ—¶é—´     |
| 4      | å·²æˆäº¤æœªç»“ä½£ | å·²æˆäº¤ä½†ä½£é‡‘æœªç»“ç®— |
| 5      | å·²æˆäº¤å·²ç»“ä½£ | å·²æˆäº¤ä¸”ä½£é‡‘å·²ç»“ç®— |

### ä¸šåŠ¡ç±»å‹ (business_type)

| ç±»å‹å€¼      | ç±»å‹åç§° | è¯´æ˜       |
| ----------- | -------- | ---------- |
| whole_rent  | æ•´ç§Ÿ     | æ•´ç§Ÿä¸šåŠ¡   |
| shared_rent | åˆç§Ÿ     | åˆç§Ÿä¸šåŠ¡   |
| centralized | é›†ä¸­     | é›†ä¸­å¼å…¬å¯“ |

### æˆ¿å‹ (room_type)

| ç±»å‹å€¼        | ç±»å‹åç§°   | è¯´æ˜       |
| ------------- | ---------- | ---------- |
| one_bedroom   | ä¸€å®¤       | ä¸€å®¤ä¸€å…   |
| two_bedroom   | ä¸¤å®¤       | ä¸¤å®¤ä¸€å…   |
| three_bedroom | ä¸‰å®¤       | ä¸‰å®¤ä¸€å…   |
| four_plus     | å››å®¤åŠä»¥ä¸Š | å››å®¤åŠä»¥ä¸Š |
| master_room   | ä¸»å§       | ä¸»å§       |
| second_room   | æ¬¡å§       | æ¬¡å§       |

### æ¥æºæ¸ é“ (source_channel)

| æ¸ é“å€¼      | æ¸ é“åç§° | è¯´æ˜       |
| ----------- | -------- | ---------- |
| xianyu      | é—²é±¼     | é—²é±¼å¹³å°   |
| xiaohongshu | å°çº¢ä¹¦   | å°çº¢ä¹¦å¹³å° |
| beike       | è´å£³     | è´å£³æ‰¾æˆ¿   |
| 58tongcheng | 58 åŒåŸ  | 58 åŒåŸ    |
| shipinhao   | è§†é¢‘å·   | å¾®ä¿¡è§†é¢‘å· |
| douyin      | æŠ–éŸ³     | æŠ–éŸ³å¹³å°   |
| referral    | æ¨è     | æ¨èæ¸ é“   |

---

## ğŸ“¤ å“åº”ç»“æœ

### æˆåŠŸå“åº” - åˆ›å»ºæ–°å®¢æˆ·

```json
{
  "success": true,
  "data": {
    "id": 123,
    "userId": "agent_user_12345",
    "action": "created"
  },
  "message": "æ–°å®¢æˆ·åˆ›å»ºæˆåŠŸ"
}
```

### æˆåŠŸå“åº” - æ›´æ–°ç°æœ‰å®¢æˆ·

```json
{
  "success": true,
  "data": {
    "id": 123,
    "userId": "agent_user_12345"
  },
  "message": "å®¢æˆ·ä¿¡æ¯å·²æ›´æ–°"
}
```

### é”™è¯¯å“åº”

```json
{
  "success": false,
  "error": "userIdä¸ºå¿…å¡«å­—æ®µ",
  "message": "è¯·æ±‚æ•°æ®éªŒè¯å¤±è´¥"
}
```



## ğŸ“‹ ä¸šåŠ¡åœºæ™¯ç¤ºä¾‹

### åœºæ™¯ä¸€ï¼šåˆ›å»ºæ–°å®¢æˆ·

**è¯·æ±‚ç¤ºä¾‹**

```json
{
  "userId": "agent_user_12345",
  "botId": "bot_001",
  "nickname": "å°å¼ ",
  "name": "å¼ ä¸‰",
  "phone": "13800138000",
  "backup_phone": "13900139000",
  "wechat": "zhangsan123",
  "status": 1,
  "community": "ä¸‡ç§‘åŸ",
  "business_type": "whole_rent",
  "room_type": "two_bedroom",
  "room_tags": "[\"loft\", \"two_bath\"]",
  "move_in_date": "2024-09-01",
  "lease_period": 12,
  "price_range": "5000-8000",
  "source_channel": "referral",
  "creator": "å¤–éƒ¨Agentç³»ç»Ÿ",
  "internal_notes": "æ¥è‡ªAgentç³»ç»Ÿæ¨é€"
}
```

**å“åº”ç¤ºä¾‹**

```json
{
  "success": true,
  "data": {
    "id": 123,
    "userId": "agent_user_12345",
    "action": "created"
  },
  "message": "æ–°å®¢æˆ·åˆ›å»ºæˆåŠŸ"
}
```

### åœºæ™¯äºŒï¼šæ›´æ–°ç°æœ‰å®¢æˆ·

**è¯·æ±‚ç¤ºä¾‹**

```json
{
  "userId": "agent_user_12345",
  "nickname": "å¼ ä¸‰ä¸°",
  "phone": "13800138001",
  "community": "ä¸‡ç§‘åŸäºŒæœŸ",
  "business_type": "shared_rent",
  "price_range": "6000-9000"
}
```

**å“åº”ç¤ºä¾‹**

```json
{
  "success": true,
  "data": {
    "id": 123,
    "userId": "agent_user_12345"
  },
  "message": "å®¢æˆ·ä¿¡æ¯å·²æ›´æ–°"
}
```

### åœºæ™¯ä¸‰ï¼šæœ€å°åŒ–æ•°æ®å½•å…¥

**è¯·æ±‚ç¤ºä¾‹**

```json
{
  "userId": "agent_user_67890",
  "name": "æå››",
  "phone": "13900139000"
}
```

**å“åº”ç¤ºä¾‹**

```json
{
  "success": true,
  "data": {
    "id": 124,
    "userId": "agent_user_67890",
    "action": "created"
  },
  "message": "æ–°å®¢æˆ·åˆ›å»ºæˆåŠŸ"
}
```

---

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### curl å‘½ä»¤æ ·ä¾‹

#### 1. åˆ›å»ºæ–°å®¢æˆ·ï¼ˆå®Œæ•´æ•°æ®ï¼‰
```bash
curl -X POST http://localhost:3000/api/external/customers \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "agent_user_12345",
    "botId": "bot_001",
    "nickname": "å°å¼ ",
    "name": "å¼ ä¸‰",
    "phone": "13800138000",
    "backup_phone": "13900139000",
    "wechat": "zhangsan123",
    "status": 1,
    "community": "ä¸‡ç§‘åŸ",
    "business_type": "whole_rent",
    "room_type": "two_bedroom",
    "room_tags": "[\"loft\", \"two_bath\"]",
    "move_in_date": "2024-09-01",
    "lease_period": 12,
    "price_range": "5000-8000",
    "source_channel": "referral",
    "creator": "å¤–éƒ¨Agentç³»ç»Ÿ",
    "internal_notes": "æ¥è‡ªAgentç³»ç»Ÿæ¨é€"
  }'
```

#### 2. æ›´æ–°ç°æœ‰å®¢æˆ·ï¼ˆéƒ¨åˆ†æ•°æ®ï¼‰

```bash
curl -X POST https://your-domain.com/api/external/customers \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "agent_user_12345",
    "nickname": "å¼ ä¸‰ä¸°",
    "phone": "13800138001",
    "community": "ä¸‡ç§‘åŸäºŒæœŸ",
    "business_type": "shared_rent",
    "price_range": "6000-9000"
  }'
```

#### 3. æœ€å°åŒ–æ•°æ®å½•å…¥

```bash
curl -X POST https://your-domain.com/api/external/customers \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "agent_user_67890",
    "name": "æå››",
    "phone": "13900139000"
  }'
```


---

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### æ•°æ®æ›´æ–°ç­–ç•¥

ç³»ç»Ÿä½¿ç”¨ `COALESCE` å‡½æ•°è¿›è¡Œæ•°æ®æ›´æ–°ï¼Œç¡®ä¿ï¼š

- åªæœ‰æ–°å€¼ä¸ä¸ºç©ºæ—¶æ‰æ›´æ–°ç°æœ‰å­—æ®µ
- ç©ºå€¼ä¸ä¼šè¦†ç›–ç°æœ‰æ•°æ®
- æ”¯æŒéƒ¨åˆ†å­—æ®µæ›´æ–°

### å¹‚ç­‰æ€§ä¿è¯

- ç›¸åŒ `userId` çš„é‡å¤è°ƒç”¨ä¸ä¼šåˆ›å»ºé‡å¤è®°å½•
- ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯åˆ›å»ºæ–°å®¢æˆ·è¿˜æ˜¯æ›´æ–°ç°æœ‰å®¢æˆ·
- æ”¯æŒå¹¶å‘è°ƒç”¨ï¼Œæ•°æ®ä¸€è‡´æ€§æœ‰ä¿éšœ

### æœ€ä½³å®è·µ

1. **æä¾›å®Œæ•´çš„å®¢æˆ·ä¿¡æ¯**ï¼šå°½é‡æä¾›å®Œæ•´çš„å­—æ®µä¿¡æ¯ï¼Œä¾¿äºåç»­ä¸šåŠ¡å¤„ç†
2. **åˆç†ä½¿ç”¨ userId**ï¼šç¡®ä¿ userId çš„å”¯ä¸€æ€§å’Œç¨³å®šæ€§
3. **é”™è¯¯å¤„ç†**ï¼šå®ç°é€‚å½“çš„é‡è¯•æœºåˆ¶å’Œé”™è¯¯å¤„ç†é€»è¾‘
4. **æ•°æ®éªŒè¯**ï¼šåœ¨è°ƒç”¨æ¥å£å‰éªŒè¯æ•°æ®çš„å®Œæ•´æ€§å’Œæ ¼å¼

---

## â“ å¸¸è§é—®é¢˜

### Q1: userId æ˜¯ä»€ä¹ˆï¼Ÿ

A: userId æ˜¯å¤–éƒ¨ç³»ç»Ÿä¸­ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºå…³è”å®¢æˆ·æ•°æ®ï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·åœ¨ä¸åŒæ—¶é—´çš„æ•°æ®èƒ½æ­£ç¡®åˆå¹¶ã€‚

### Q2: å¦‚æœå®¢æˆ·ä¿¡æ¯å‘ç”Ÿå˜åŒ–æ€ä¹ˆåŠï¼Ÿ

A: ç³»ç»Ÿæ”¯æŒæ•°æ®æ›´æ–°ï¼Œç›¸åŒ userId çš„åç»­è¯·æ±‚ä¼šæ›´æ–°ç°æœ‰å®¢æˆ·ä¿¡æ¯ï¼Œä¸ä¼šåˆ›å»ºé‡å¤è®°å½•ã€‚

### Q3: æ”¯æŒå“ªäº›æ•°æ®æ ¼å¼ï¼Ÿ

A:

- æ—¶é—´æ ¼å¼ï¼šYYYY-MM-DD (å¦‚: "2024-09-01")
- ç”µè¯æ ¼å¼ï¼šä¸­å›½å¤§é™†æ‰‹æœºå· (å¦‚: "13800138000")
- ä»·æ ¼èŒƒå›´ï¼šå­—ç¬¦ä¸²æ ¼å¼ (å¦‚: "5000-8000")
- æˆ¿å‹æ ‡ç­¾ï¼šJSON æ•°ç»„å­—ç¬¦ä¸² (å¦‚: "[\"loft\", \"two_bath\"]")

### Q4: å¦‚ä½•å¤„ç†å¹¶å‘è¯·æ±‚ï¼Ÿ

A: ç³»ç»Ÿå†…ç½®äº†è¯·æ±‚æ—¥å¿—å’Œé”™è¯¯å¤„ç†æœºåˆ¶ï¼Œæ”¯æŒé€‚åº¦å¹¶å‘ï¼Œå»ºè®®æ§åˆ¶åœ¨ 10 è¯·æ±‚/ç§’ä»¥å†…ã€‚

### Q5: æ‰‹æœºå·é‡å¤æ€ä¹ˆåŠï¼Ÿ

A: ç³»ç»Ÿä¼šæ£€æŸ¥æ‰‹æœºå·çš„å”¯ä¸€æ€§ï¼Œå¦‚æœæ‰‹æœºå·å·²å­˜åœ¨ï¼Œä¼šè¿”å›ç›¸åº”çš„é”™è¯¯ä¿¡æ¯ã€‚

### Q6: å¿…å¡«å­—æ®µæœ‰å“ªäº›ï¼Ÿ

A: åªæœ‰ `userId` æ˜¯å¿…å¡«å­—æ®µï¼Œå…¶ä»–å­—æ®µéƒ½æ˜¯å¯é€‰çš„ã€‚

