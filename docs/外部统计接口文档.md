# 外部统计接口文档

> 文档更新时间：2025-01-27  
> 接口版本：v1.0  
> 适用于：外部系统统计数据查询  
> 基础 URL：`http://localhost:3000/api/external`

## 📋 接口概览

外部统计接口提供 CRM 系统的核心统计数据，包括约看数量、客户成交状态统计和佣金总金额等关键业务指标。

- **接口地址**: `GET /api/external/statistics`
- **功能描述**: 获取指定时间范围内的统计数据
- **数据来源**: 带看记录表和客户表
- **返回格式**: JSON

---

### 错误处理
所有接口都遵循统一的错误响应格式：

```json
{
  "success": false,
  "error": "错误代码",
  "message": "错误描述"
}
```

---

## 📝 请求参数

### 查询参数（URL 参数）

| 参数名      | 类型   | 必填 | 默认值 | 说明                       |
| ----------- | ------ | ---- | ------ | -------------------------- |
| `date_from` | string | ❌   | -      | 开始日期，格式：YYYY-MM-DD |
| `date_to`   | string | ❌   | -      | 结束日期，格式：YYYY-MM-DD |

### 参数说明

#### 查询逻辑

1. 如果不提供 `date_from` 和 `date_to`，查询所有数据
2. 如果提供 `date_from` 和 `date_to`，按时间范围筛选数据

---

## 📊 响应结果

### 成功响应

```json
{
  "success": true,
  "data": {
    "viewing_count": 150,
    "completed_unpaid_count": 25,
    "completed_paid_count": 10,
    "total_commission": 125000.0,
    "period": {
      "date_from": "2024-01-01",
      "date_to": "2024-01-31"
    }
  },
  "message": "统计数据获取成功"
}
```

### 响应字段说明

| 字段名                   | 类型   | 说明                                      |
| ------------------------ | ------ | ----------------------------------------- |
| `viewing_count`          | number | 约看数量（指定时间范围内的带看记录数）    |
| `completed_unpaid_count` | number | 已成交未结佣客户数（客户状态为 4 的总数） |
| `completed_paid_count`   | number | 已成交已结佣客户数（客户状态为 5 的总数） |
| `total_commission`       | number | 佣金总金额（指定时间范围内的佣金总和）    |
| `period.date_from`       | string | 查询开始日期                              |
| `period.date_to`         | string | 查询结束日期                              |

### 错误响应

#### 日期格式错误

```json
{
  "success": false,
  "error": "INVALID_DATE_FORMAT",
  "message": "开始日期格式无效，请使用YYYY-MM-DD格式"
}
```

---

## 📈 数据说明

### 数据来源

1. **约看数量** (`viewing_count`)

   - 来源：`qft_ai_viewing_records` 表
   - 筛选条件：`created_at` 在指定时间范围内
   - 统计方式：COUNT(\*)

2. **佣金总金额** (`total_commission`)

   - 来源：`qft_ai_viewing_records` 表
   - 筛选条件：`created_at` 在指定时间范围内
   - 统计方式：SUM(commission)

3. **已成交未结佣客户数** (`completed_unpaid_count`)

   - 来源：`qft_ai_customers` 表
   - 筛选条件：`status = 4`
   - 统计方式：COUNT(\*)

4. **已成交已结佣客户数** (`completed_paid_count`)
   - 来源：`qft_ai_customers` 表
   - 筛选条件：`status = 5`
   - 统计方式：COUNT(\*)

### 客户状态说明

| 状态值 | 状态名称     | 说明               |
| ------ | ------------ | ------------------ |
| 1      | 跟进中       | 客户正在跟进中     |
| 2      | 客户不再回复 | 客户停止回复       |
| 3      | 已约带看     | 已预约带看时间     |
| 4      | 已成交未结佣 | 已成交但佣金未结算 |
| 5      | 已成交已结佣 | 已成交且佣金已结算 |

---

## 🔧 使用示例

### 1. 查询所有数据（默认）

```bash
curl -X GET "http://localhost:3000/api/external/statistics"
```

### 2. 查询指定时间范围

```bash
curl -X GET "http://localhost:3000/api/external/statistics?date_from=2025-08-19&date_to=2024-08-19"
```

### 3. 查询指定时间范围

```bash
curl -X GET "https://your-domain.com/api/external/statistics?date_from=2024-01-01&date_to=2024-01-31" \
  -H "Content-Type: application/json" \
```

---

## ❓ 常见问题

### Q1: 为什么客户状态统计不按时间筛选？

A: 根据业务需求，已成交未结佣和已成交已结佣的客户数量是基于当前客户状态统计的，不按时间筛选。这样可以反映当前的整体客户状态分布。

### Q2: 佣金总金额包含哪些记录？

A: 佣金总金额只包含指定时间范围内创建的带看记录的佣金总和，不包含其他来源的佣金。

### Q3: 如何处理时区问题？

A: 系统使用服务器本地时区（UTC+8），所有时间计算都基于此时区。建议客户端在发送请求时使用相同的时区。

### Q4: 数据更新频率如何？

A: 统计数据实时计算，每次请求都会获取最新的数据。客户状态统计基于当前客户表状态，约看和佣金统计基于指定时间范围。
