# 外部统计接口文档

> 文档更新时间：2025-01-27  
> 接口版本：v1.1  
> 适用于：外部系统统计数据查询  
> 基础 URL：`http://localhost:3000/api/external`

## 📋 接口概览

外部统计接口提供 CRM 系统的核心统计数据，包括约看数量、客户成交状态统计和佣金总金额等关键业务指标。支持按客户 ID 和托管 ID 进行筛选查询。

- **接口地址**: `GET /api/external/statistics`
- **功能描述**: 获取指定时间范围和客户/托管筛选条件下的统计数据
- **数据来源**: 带看记录表和客户表
- **返回格式**: JSON

---

### 错误处理

所有接口都遵循统一的错误响应格式：

```json
{
  "success": false,
  "error": "错误代码",
  "message": "错误描述"
}
```

---

## 📝 请求参数

### 查询参数（URL 参数）

| 参数名      | 类型   | 必填 | 默认值 | 说明                                        |
| ----------- | ------ | ---- | ------ | ------------------------------------------- |
| `date_from` | string | ❌   | -      | 开始日期，格式：YYYY-MM-DD                  |
| `date_to`   | string | ❌   | -      | 结束日期，格式：YYYY-MM-DD                  |
| `userId`    | string | ❌   | -      | 客户 ID，支持批量查询（多个 ID 用逗号分隔） |
| `botId`     | string | ❌   | -      | 托管 ID，支持批量查询（多个 ID 用逗号分隔） |

### 参数说明

#### 查询逻辑

1. **时间筛选**：如果不提供 `date_from` 和 `date_to`，查询所有时间的数据
2. **客户筛选**：如果不提供 `userId` 和 `botId`，查询所有客户的数据
3. **交集查询**：当同时提供 `userId` 和 `botId` 时，使用交集逻辑（AND）
4. **参数组合**：时间筛选与客户筛选可以组合使用

#### 参数格式示例

```
# 单个客户ID查询
GET /api/external/statistics?userId=123

# 批量客户ID查询
GET /api/external/statistics?userId=123,456,789

# 单个托管ID查询
GET /api/external/statistics?botId=bot1

# 批量托管ID查询
GET /api/external/statistics?botId=bot1,bot2,bot3

# 组合查询（交集）
GET /api/external/statistics?userId=123,456&botId=bot1,bot2

# 时间+客户组合查询
GET /api/external/statistics?date_from=2024-01-01&date_to=2024-01-31&userId=123&botId=bot1
```

---

## 📊 响应结果

### 成功响应

```json
{
  "success": true,
  "data": {
    "viewing_count": 150,
    "completed_unpaid_count": 25,
    "completed_paid_count": 10,
    "total_commission": 125000.0,
    "period": {
      "date_from": "2024-01-01",
      "date_to": "2024-01-31"
    },
    "filters": {
      "userIds": ["123", "456", "789"],
      "botIds": ["bot1", "bot2"]
    }
  },
  "message": "统计数据获取成功"
}
```

### 响应字段说明

| 字段名                   | 类型   | 说明                                                    |
| ------------------------ | ------ | ------------------------------------------------------- |
| `viewing_count`          | number | 约看数量（指定筛选条件下的带看记录数）                  |
| `completed_unpaid_count` | number | 已成交未结佣客户数（指定筛选条件下客户状态为 4 的总数） |
| `completed_paid_count`   | number | 已成交已结佣客户数（指定筛选条件下客户状态为 5 的总数） |
| `total_commission`       | number | 佣金总金额（指定筛选条件下的佣金总和）                  |
| `period.date_from`       | string | 查询开始日期                                            |
| `period.date_to`         | string | 查询结束日期                                            |
| `filters.userIds`        | array  | 当前使用的客户 ID 筛选条件（仅在有筛选时返回）          |
| `filters.botIds`         | array  | 当前使用的托管 ID 筛选条件（仅在有筛选时返回）          |

### 错误响应

#### 日期格式错误

```json
{
  "success": false,
  "error": "INVALID_DATE_FORMAT",
  "message": "开始日期格式无效，请使用YYYY-MM-DD格式"
}
```

---

## 📈 数据说明

### 数据来源

1. **约看数量** (`viewing_count`)

   - 来源：`qft_ai_viewing_records` 表
   - 筛选条件：
     - `created_at` 在指定时间范围内（如果提供时间参数）
     - 关联的客户满足 `userId` 和 `botId` 筛选条件（如果提供客户参数）
   - 统计方式：COUNT(\*)

2. **佣金总金额** (`total_commission`)

   - 来源：`qft_ai_viewing_records` 表
   - 筛选条件：
     - `created_at` 在指定时间范围内（如果提供时间参数）
     - 关联的客户满足 `userId` 和 `botId` 筛选条件（如果提供客户参数）
   - 统计方式：SUM(commission)

3. **已成交未结佣客户数** (`completed_unpaid_count`)

   - 来源：`qft_ai_customers` 表
   - 筛选条件：
     - `status = 4`
     - 满足 `userId` 和 `botId` 筛选条件（如果提供客户参数）
   - 统计方式：COUNT(\*)

4. **已成交已结佣客户数** (`completed_paid_count`)
   - 来源：`qft_ai_customers` 表
   - 筛选条件：
     - `status = 5`
     - 满足 `userId` 和 `botId` 筛选条件（如果提供客户参数）
   - 统计方式：COUNT(\*)

### 客户状态说明

| 状态值 | 状态名称     | 说明               |
| ------ | ------------ | ------------------ |
| 1      | 跟进中       | 客户正在跟进中     |
| 2      | 客户不再回复 | 客户停止回复       |
| 3      | 已约带看     | 已预约带看时间     |
| 4      | 已成交未结佣 | 已成交但佣金未结算 |
| 5      | 已成交已结佣 | 已成交且佣金已结算 |

### 筛选逻辑说明

#### 交集查询（AND 逻辑）

当同时提供 `userId` 和 `botId` 参数时，系统会查找同时满足以下条件的客户：

- 客户的 `userId` 在提供的 `userId` 列表中
- 客户的 `botId` 在提供的 `botId` 列表中

#### 单条件查询

- 只提供 `userId`：查找 `userId` 在指定列表中的客户
- 只提供 `botId`：查找 `botId` 在指定列表中的客户

---

## 🔧 使用示例

### 1. 查询所有数据（默认）

```bash
curl -X GET "http://localhost:3000/api/external/statistics"
```

### 2. 查询指定时间范围

```bash
curl -X GET "http://localhost:3000/api/external/statistics?date_from=2024-01-01&date_to=2024-01-31"
```

### 3. 查询指定客户 ID

```bash
curl -X GET "http://localhost:3000/api/external/statistics?userId=123,456,789"
```

### 4. 查询指定托管 ID

```bash
curl -X GET "http://localhost:3000/api/external/statistics?botId=bot1,bot2,bot3"
```

### 5. 交集查询（同时满足客户 ID 和托管 ID）

```bash
curl -X GET "http://localhost:3000/api/external/statistics?userId=agent_user_12345,test_user_001&botId=bot_001,bot2"
```

### 6. 组合查询（时间+客户筛选）

```bash
curl -X GET "http://localhost:3000/api/external/statistics?date_from=2024-01-01&date_to=2024-01-31&userId=123&botId=bot1"
```

---

## ❓ 常见问题

### Q1: 为什么客户状态统计不按时间筛选？

A: 根据业务需求，已成交未结佣和已成交已结佣的客户数量是基于当前客户状态统计的，不按时间筛选。这样可以反映当前的整体客户状态分布。

### Q2: 交集查询的逻辑是什么？

A: 当同时提供 `userId` 和 `botId` 参数时，系统会查找同时满足两个条件的客户。例如：`userId=123,456&botId=bot1` 会查找 `userId` 为 123 或 456，且 `botId` 为 bot1 的客户。

### Q3: 支持多少个 ID 的批量查询？

A: 目前没有限制批量查询的 ID 数量，但建议单次查询的 ID 数量不要超过 1000 个，以保证查询性能。
