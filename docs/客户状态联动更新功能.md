# 客户状态联动更新功能

## 功能概述

当带看记录的带看反馈更新为"已成交"时，系统会自动将对应客户的状态更新为"已成交未结佣"，实现客户状态与带看记录的智能联动。

## 触发条件

- **客户存在**: 带看记录必须关联到有效的客户 (`customer_id` 不为空)
- **成交记录存在**: 该客户有任何一条带看记录的反馈为"已成交" (`viewing_feedback = 1`)
- **状态变更**: 只有当客户当前状态不是"已成交未结佣"时才会更新

## 状态映射

| 带看反馈 | 客户状态     | 状态值 | 说明                   |
| -------- | ------------ | ------ | ---------------------- |
| 已成交   | 已成交未结佣 | 4      | 客户已成交但佣金未结算 |

## 实现位置

### 1. 内部带看记录更新 API

- **文件**: `src/app/api/viewing-records/[id]/route.ts`
- **方法**: `PUT`
- **功能**: 更新现有带看记录时触发联动

### 2. 内部带看记录创建 API

- **文件**: `src/app/api/viewing-records/route.ts`
- **方法**: `POST`
- **功能**: 创建新带看记录时触发联动

### 3. 外部带看记录 API

- **文件**: `src/app/api/external/viewing-records/route.ts`
- **方法**: `POST`
- **功能**: 外部系统录入带看记录时触发联动

## 代码实现

### 联动逻辑

```typescript
// 检查是否需要联动更新客户状态
if (existingRecord.customer_id) {
  // 检查该客户是否有任何带看记录的反馈为'已成交'
  const hasDealFeedback = await dbManager.queryOne<{ count: number }>(
    "SELECT COUNT(*) as count FROM qft_ai_viewing_records WHERE customer_id = ? AND viewing_feedback = 1",
    [existingRecord.customer_id]
  );

  if (hasDealFeedback && hasDealFeedback.count > 0) {
    // 当客户有任何带看记录的反馈为'已成交'时，将客户状态更新为'已成交未结佣'
    const customerUpdateSql = `
      UPDATE qft_ai_customers 
      SET status = 4, updated_at = CURRENT_TIMESTAMP 
      WHERE id = ? AND status != 4
    `;

    const customerResult = await dbManager.execute(customerUpdateSql, [
      existingRecord.customer_id,
    ]);

    if (customerResult.changes > 0) {
      requestLogger.info(
        {
          recordId: id,
          customerId: existingRecord.customer_id,
          dealCount: hasDealFeedback.count,
          requestId,
        },
        "客户状态已联动更新为已成交未结佣（基于所有带看记录）"
      );
    }
  }
}
```

### 关键特性

1. **全局检查**: 检查该客户的所有带看记录，只要有任何一条记录的反馈为"已成交"就触发联动
2. **避免重复更新**: 使用 `WHERE id = ? AND status != 4` 条件避免重复更新
3. **日志记录**: 记录联动操作的详细信息，包括成交记录数量
4. **事务安全**: 在现有事务中执行，确保数据一致性

## 测试覆盖

### 测试用例

- **文件**: `tests/api.viewing-records.id.handlers.test.ts`
- **测试 1**: 验证当客户有任何带看记录的反馈为"已成交"时，客户状态正确更新为 4
- **测试 2**: 验证当客户没有任何带看记录的反馈为"已成交"时，不会更新客户状态
- **测试 3**: 验证当客户状态已经是 4 时，不会重复更新

### 测试结果

```
✓ PUT should update customer status when any viewing record has deal feedback
✓ PUT should not update customer status if no viewing records have deal feedback
✓ PUT should not update customer status if already status 4
```

## 使用场景

1. **销售跟进**: 销售人员更新任何带看记录的反馈为"已成交"后，客户状态自动更新
2. **数据同步**: 外部系统录入成交信息时，客户状态自动同步
3. **状态管理**: 确保客户状态与所有带看记录中的成交信息保持一致
4. **历史记录**: 即使后续带看记录反馈改为"未成交"，只要客户有任何成交记录，状态仍保持"已成交未结佣"

## 注意事项

1. **单向联动**: 目前只支持从带看记录到客户状态的单向联动
2. **状态值**: 客户状态 4 表示"已成交未结佣"，后续可能需要手动更新为"已成交已结佣"
3. **日志记录**: 所有联动操作都会记录详细日志，便于追踪和调试
4. **性能考虑**: 联动操作在现有事务中执行，不会增加额外的数据库连接开销

## 未来扩展

1. **反向联动**: 考虑从客户状态变化反向更新带看记录
2. **状态映射**: 支持更多状态值的映射关系
3. **批量处理**: 支持批量更新客户状态
4. **通知机制**: 联动更新时发送通知给相关人员
