# API é”™è¯¯å¤„ç†æ”¹è¿›æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ¬¡æ”¹è¿›ç»Ÿä¸€äº† CRM ç³»ç»Ÿæ‰€æœ‰ API è·¯ç”±çš„é”™è¯¯å¤„ç†æ ¼å¼ï¼Œæå‡äº†å‰ç«¯é”™è¯¯å¤„ç†çš„ä¸€è‡´æ€§å’Œç”¨æˆ·ä½“éªŒã€‚åŒæ—¶ç§»é™¤äº†ä¸å¿…è¦çš„å¿…å¡«å­—æ®µé™åˆ¶ï¼Œæé«˜äº†æ•°æ®å½•å…¥çš„çµæ´»æ€§ã€‚

## æ”¹è¿›å†…å®¹

### 1. ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼

æ‰€æœ‰ API ç°åœ¨è¿”å›ä¸€è‡´çš„é”™è¯¯æ ¼å¼ï¼š

```json
{
  "success": false,
  "error": "é”™è¯¯æè¿°ä¿¡æ¯",
  "errorType": "ERROR_TYPE",
  "details": "è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰"
}
```

### 2. é”™è¯¯ç±»å‹æšä¸¾

```typescript
export enum ApiErrorType {
  VALIDATION_ERROR = "VALIDATION_ERROR", // è¾“å…¥éªŒè¯é”™è¯¯
  NOT_FOUND = "NOT_FOUND", // èµ„æºä¸å­˜åœ¨
  DUPLICATE_RESOURCE = "DUPLICATE_RESOURCE", // é‡å¤èµ„æº
  DATABASE_ERROR = "DATABASE_ERROR", // æ•°æ®åº“é”™è¯¯
  UNAUTHORIZED = "UNAUTHORIZED", // æœªæˆæƒ
  FORBIDDEN = "FORBIDDEN", // ç¦æ­¢è®¿é—®
  INTERNAL_ERROR = "INTERNAL_ERROR", // å†…éƒ¨é”™è¯¯
}
```

### 3. é”™è¯¯å¤„ç†ä¸­é—´ä»¶

- `withErrorHandler`: è‡ªåŠ¨æ•è·å’Œå¤„ç†å¼‚å¸¸
- `createErrorResponse`: åˆ›å»ºæ ‡å‡†é”™è¯¯å“åº”
- `createSuccessResponse`: åˆ›å»ºæ ‡å‡†æˆåŠŸå“åº”

### 4. çµæ´»çš„è¾“å…¥éªŒè¯

**ç§»é™¤çš„é™åˆ¶**ï¼š

- ç§»é™¤äº†æ‰€æœ‰å¿…å¡«å­—æ®µéªŒè¯
- ç§»é™¤äº†æ•°æ®åº“å±‚é¢çš„ NOT NULL çº¦æŸ
- å…è®¸åˆ›å»ºå®Œå…¨ç©ºçš„è®°å½•

**ä¿ç•™çš„éªŒè¯**ï¼š

- æ‰‹æœºå·æ ¼å¼éªŒè¯ï¼ˆå¦‚æœæä¾›ï¼‰
- å­—æ®µé•¿åº¦é™åˆ¶éªŒè¯
- æ•°å€¼èŒƒå›´éªŒè¯
- é‡å¤æ‰‹æœºå·æ£€æŸ¥

## æ•°æ®çµæ´»æ€§æ”¹è¿›

### ä¹‹å‰çš„é™åˆ¶

- å®¢æˆ·å§“åå¿…å¡«
- å°åŒºåç§°å¿…å¡«
- ä¸šåŠ¡ç±»å‹å¿…å¡«
- å½•å…¥äººå¿…å¡«
- å¸¦çœ‹è®°å½•çš„å®¢æˆ· ID å¿…å¡«
- é¢„çº¦çš„ç‰©ä¸šåç§°å¿…å¡«

### ç°åœ¨çš„çµæ´»æ€§

- **æ‰€æœ‰å­—æ®µéƒ½å¯é€‰**: å…è®¸éƒ¨åˆ†ä¿¡æ¯å½•å…¥ï¼Œåç»­è¡¥å……
- **é»˜è®¤å€¼å¤„ç†**: ç©ºå­—æ®µè‡ªåŠ¨å¡«å……åˆç†é»˜è®¤å€¼
- **æ¸è¿›å¼æ•°æ®å®Œå–„**: æ”¯æŒå…ˆåˆ›å»ºæ¡†æ¶ï¼Œå†é€æ­¥å®Œå–„ä¿¡æ¯

### ä½¿ç”¨åœºæ™¯

1. **å¿«é€Ÿè®°å½•**: æ¥ç”µè¯æ—¶å¿«é€Ÿåˆ›å»ºå®¢æˆ·è®°å½•
2. **åˆ†é˜¶æ®µå½•å…¥**: å…ˆè®°å½•åŸºæœ¬ä¿¡æ¯ï¼Œåç»­è¡¥å……è¯¦ç»†ä¿¡æ¯
3. **æ•°æ®å¯¼å…¥**: ä»ä¸å®Œæ•´çš„æ•°æ®æºå¯¼å…¥è®°å½•
4. **ç³»ç»Ÿé›†æˆ**: ä¸å…¶ä»–ç³»ç»Ÿäº¤æ¢ä¸å®Œæ•´æ•°æ®

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ç”¨æ³•

```typescript
export const POST = withErrorHandler(async (request: NextRequest) => {
  const body = await request.json();

  // éªŒè¯è¾“å…¥ï¼ˆåªæ£€æŸ¥æ ¼å¼ï¼Œä¸å¼ºåˆ¶å¿…å¡«ï¼‰
  validateCustomerData(body);

  // ä¸šåŠ¡é€»è¾‘
  const result = await dbManager.execute(sql, params);

  // è¿”å›æˆåŠŸå“åº”
  return createSuccessResponse(result, "æ“ä½œæˆåŠŸ", 201);
});
```

### åˆ›å»ºç©ºè®°å½•ç¤ºä¾‹

```bash
# åˆ›å»ºç©ºå®¢æˆ·è®°å½•
curl -X POST /api/customers -d '{}'
â†’ {"success":true,"data":{"id":24,"name":"","phone":null,...}}

# åˆ›å»ºåªæœ‰éƒ¨åˆ†ä¿¡æ¯çš„é¢„çº¦
curl -X POST /api/appointments -d '{"customer_phone":"13888999000"}'
â†’ {"success":true,"data":{"id":18,...}}

# åˆ›å»ºä¸å…³è”å®¢æˆ·çš„å¸¦çœ‹è®°å½•
curl -X POST /api/viewing-records -d '{"property_name":"æµ‹è¯•æ¥¼ç›˜","commission":500}'
â†’ {"success":true,"data":{"id":11}}
```

### é”™è¯¯å¤„ç†

```typescript
// æ ¼å¼éªŒè¯é”™è¯¯ï¼ˆä»ç„¶ä¿ç•™ï¼‰
if (invalidPhoneFormat) {
  throw createValidationError("æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®");
}

// é‡å¤èµ„æºé”™è¯¯
if (duplicateRecord) {
  throw createDuplicateError("æ‰‹æœºå·");
}

// æ•°æ®åº“é”™è¯¯
try {
  await dbManager.execute(sql, params);
} catch (error) {
  throw createDatabaseError("åˆ›å»ºå®¢æˆ·", error as Error);
}
```

## å‰ç«¯é”™è¯¯å¤„ç†

ç°åœ¨å‰ç«¯å¯ä»¥ç»Ÿä¸€å¤„ç†æ‰€æœ‰ API é”™è¯¯ï¼š

```typescript
try {
  const response = await fetch("/api/customers", options);
  const result = await response.json();

  if (!result.success) {
    switch (result.errorType) {
      case "VALIDATION_ERROR":
        message.error(`è¾“å…¥é”™è¯¯: ${result.error}`);
        break;
      case "NOT_FOUND":
        message.error("èµ„æºä¸å­˜åœ¨");
        break;
      case "DUPLICATE_RESOURCE":
        message.error(`èµ„æºå·²å­˜åœ¨: ${result.error}`);
        break;
      default:
        message.error("æ“ä½œå¤±è´¥");
    }
  }
} catch (error) {
  message.error("ç½‘ç»œè¯·æ±‚å¤±è´¥");
}
```

## æ•°æ®åº“è¿ç§»

ä¸ºäº†ç§»é™¤ NOT NULL çº¦æŸï¼Œæˆ‘ä»¬è¿›è¡Œäº†æ•°æ®åº“ç»“æ„è¿ç§»ï¼š

1. **å¤‡ä»½ç°æœ‰æ•°æ®**
2. **é‡å»ºè¡¨ç»“æ„**ï¼ˆç§»é™¤ NOT NULL çº¦æŸï¼‰
3. **è¿ç§»æ•°æ®**ï¼ˆä½¿ç”¨ COALESCE æä¾›é»˜è®¤å€¼ï¼‰
4. **æ¸…ç†å¤‡ä»½è¡¨**

è¿ç§»åçš„æ”¹è¿›ï¼š

- `customer_id` å¯ä¸ºç©ºï¼ˆå…è®¸ç‹¬ç«‹çš„å¸¦çœ‹è®°å½•ï¼‰
- æ‰€æœ‰æ–‡æœ¬å­—æ®µå¯ä¸ºç©ºï¼ˆæä¾›é»˜è®¤å€¼ï¼‰
- å¤–é”®çº¦æŸæ”¹ä¸º `ON DELETE SET NULL`ï¼ˆæ›´å®‰å…¨ï¼‰

## å·²æ›´æ–°çš„ API è·¯ç”±

- âœ… `/api/customers` (GET, POST, PUT) - ç§»é™¤å¿…å¡«é™åˆ¶
- âœ… `/api/appointments` (POST) - ç§»é™¤å¿…å¡«é™åˆ¶
- âœ… `/api/viewing-records` (POST) - ç§»é™¤å¿…å¡«é™åˆ¶
- ğŸ”„ `/api/appointments/[id]` (å¾…æ›´æ–°)

## æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ä¼˜åŒ–

- **å‡å°‘éªŒè¯å¼€é”€**: ä¸å†æ£€æŸ¥å¤§é‡å¿…å¡«å­—æ®µ
- **æé«˜æ•°æ®å½•å…¥æ•ˆç‡**: æ”¯æŒå¿«é€Ÿéƒ¨åˆ†å½•å…¥
- **é™ä½ç”¨æˆ·é—¨æ§›**: å‡å°‘è¡¨å•éªŒè¯é”™è¯¯
- **å¢å¼ºç³»ç»Ÿçµæ´»æ€§**: é€‚åº”å„ç§ä¸šåŠ¡åœºæ™¯

## å‘åå…¼å®¹æ€§

- âœ… **å®Œå…¨å‘åå…¼å®¹**: åŸæœ‰çš„å®Œæ•´æ•°æ®å½•å…¥æ–¹å¼ä»ç„¶æœ‰æ•ˆ
- âœ… **API æ ¼å¼ä¸å˜**: åªæ˜¯æ”¾å®½äº†éªŒè¯é™åˆ¶
- âœ… **æ•°æ®ç»“æ„ä¿æŒ**: æ‰€æœ‰å­—æ®µä»ç„¶å­˜åœ¨ï¼Œåªæ˜¯å˜ä¸ºå¯é€‰
- âœ… **å‰ç«¯æ— éœ€ä¿®æ”¹**: ç°æœ‰å‰ç«¯ä»£ç æ— éœ€ä»»ä½•æ”¹åŠ¨

## æ•°æ®åº“ç»´æŠ¤å‘½ä»¤

```bash
# é‡å»ºæ•°æ®åº“ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
npm run db:reset

# åˆå§‹åŒ–æ•°æ®åº“
npm run db:setup
```
