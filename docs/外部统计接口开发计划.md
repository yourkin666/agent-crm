# 外部统计接口开发计划文档

## 📋 项目概述

### 需求分析

根据您的需求，需要开发一个外部统计接口，提供以下四个关键数据：

1. **约看数量** - 根据时间筛选的带看记录数量
2. **已成交未结佣客户数** - 客户表中状态为 4 的客户总数（不按时间筛选）
3. **已成交已结佣客户数** - 客户表中状态为 5 的客户总数（不按时间筛选）
4. **佣金总金额** - 根据时间筛选的带看记录佣金总和

### 数据来源分析

- **约看数量** 和 **佣金总金额**：来自 `qft_ai_viewing_records` 表，按 `created_at` 时间筛选
- **已成交未结佣** 和 **已成交已结佣**：来自 `qft_ai_customers` 表，按 `status` 字段统计（不按时间筛选）

## 🎯 技术方案

### 1. 接口设计

#### 接口路径

```
GET /api/external/statistics
```

#### 请求参数

| 参数名      | 类型   | 必填 | 说明                                |
| ----------- | ------ | ---- | ----------------------------------- |
| `date_from` | string | ❌   | 开始日期 (YYYY-MM-DD)，默认 30 天前 |
| `date_to`   | string | ❌   | 结束日期 (YYYY-MM-DD)，默认今天     |
| `period`    | string | ❌   | 时间周期 (day/week/month)，默认 day |

#### 响应格式

```json
{
  "success": true,
  "data": {
    "viewing_count": 150,
    "completed_unpaid_count": 25,
    "completed_paid_count": 10,
    "total_commission": 125000.0,
    "period": {
      "date_from": "2024-01-01",
      "date_to": "2024-01-31"
    }
  },
  "message": "统计数据获取成功"
}
```

### 2. 数据库查询设计

#### 约看数量和佣金总金额查询

```sql
SELECT
  COUNT(*) as viewing_count,
  SUM(commission) as total_commission
FROM qft_ai_viewing_records
WHERE created_at BETWEEN ? AND ?
```

#### 客户状态统计查询

```sql
SELECT
  SUM(CASE WHEN status = 4 THEN 1 ELSE 0 END) as completed_unpaid_count,
  SUM(CASE WHEN status = 5 THEN 1 ELSE 0 END) as completed_paid_count
FROM qft_ai_customers
```

## 📁 文件结构规划

### 1. 新增文件

```
src/app/api/external/statistics/
├── route.ts                    # 主接口文件
└── README.md                   # 接口文档
```

### 2. 修改文件

```
docs/
├── 外部统计接口文档.md          # 新增文档
└── 外部API接口文档.md           # 更新现有文档
```

## 🚀 开发步骤

### 阶段一：接口开发 (预计 2 小时)

1. **创建接口文件**

   - 创建 `src/app/api/external/statistics/route.ts`
   - 实现参数验证逻辑
   - 实现数据库查询逻辑
   - 实现错误处理

2. **核心功能实现**
   - 时间参数解析和默认值处理
   - 数据库查询优化（使用事务确保数据一致性）
   - 响应数据格式化

### 阶段二：文档编写 (预计 1 小时)

1. **接口文档**

   - 创建 `docs/外部统计接口文档.md`
   - 详细说明接口参数和响应格式
   - 提供使用示例

2. **更新现有文档**
   - 在 `docs/外部API接口文档.md` 中添加新接口说明

### 阶段三：测试验证 (预计 1 小时)

1. **单元测试**

   - 创建 `tests/api.external.statistics.handlers.test.ts`
   - 测试各种参数组合
   - 测试边界情况

2. **集成测试**
   - 测试真实数据库查询
   - 验证数据准确性

### 阶段四：部署和验证 (预计 30 分钟)

1. **部署验证**
   - 本地测试接口功能
   - 验证日志记录
   - 性能测试

## 🔧 技术实现细节

### 1. 参数验证

```typescript
interface StatisticsQuery {
  date_from?: string;
  date_to?: string;
  period?: "day" | "week" | "month";
}
```

### 2. 时间处理逻辑

- 如果提供 `date_from` 和 `date_to`，直接使用
- 如果提供 `period`，计算对应的时间范围
- 如果都不提供，默认查询最近 30 天

### 3. 数据库查询优化

- 使用索引优化查询性能
- 考虑使用缓存减少重复查询
- 添加查询超时处理

### 4. 错误处理

- 参数验证错误 (400)
- 数据库查询错误 (500)
- 统一的错误响应格式

## ⚡ 性能考虑

### 1. 查询优化

- 在 `qft_ai_viewing_records.created_at` 上建立索引
- 在 `qft_ai_customers.status` 上建立索引
- 考虑分页查询大量数据

### 2. 缓存策略

- 对于频繁查询的时间范围，考虑添加 Redis 缓存
- 缓存时间设置为 5 分钟

### 3. 监控和日志

- 记录查询执行时间
- 记录查询参数和结果
- 添加性能监控

## 🧪 测试计划

### 1. 功能测试

- [x] 测试不同时间范围参数
- [x] 测试默认参数情况
- [x] 测试边界日期
- [x] 测试无效参数处理

### 2. 性能测试

- [x] 测试大数据量查询性能
- [x] 测试并发请求处理
- [x] 测试内存使用情况

### 3. 集成测试

- [x] 测试与现有系统的兼容性
- [x] 测试日志记录功能
- [x] 测试错误处理机制

## 📅 时间安排

| 阶段     | 任务     | 预计时间     | 负责人   |
| -------- | -------- | ------------ | -------- |
| 1        | 接口开发 | 2 小时       | 开发人员 |
| 2        | 文档编写 | 1 小时       | 开发人员 |
| 3        | 测试验证 | 1 小时       | 开发人员 |
| 4        | 部署验证 | 30 分钟      | 开发人员 |
| **总计** |          | **4.5 小时** |          |

## ✅ 验收标准

### 功能验收

- [x] 接口能正确返回四个统计数据
- [x] 时间筛选功能正常工作
- [x] 参数验证和错误处理完善
- [x] 响应格式符合规范

### 性能验收

- [x] 查询响应时间 < 500ms
- [x] 支持并发请求
- [x] 内存使用合理

### 文档验收

- [x] 接口文档完整清晰
- [x] 使用示例正确
- [x] 错误码说明完整

## 🔄 后续优化

### 1. 功能扩展

- 支持更多时间周期（季度、年度）
- 支持按地区、业务类型等维度统计
- 支持数据导出功能

### 2. 性能优化

- 实现数据预聚合
- 添加更智能的缓存策略
- 优化数据库查询计划

### 3. 监控告警

- 添加接口调用量监控
- 设置性能告警阈值
- 实现异常情况自动告警

---

**文档版本**: v1.0  
**创建时间**: 2025-01-27  
**最后更新**: 2025-01-27  
**开发状态**: ✅ 已完成
