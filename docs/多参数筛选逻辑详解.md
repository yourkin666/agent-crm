# 多参数筛选逻辑详解

## 📋 筛选逻辑概述

### 示例 3：同时传 userId 和 botId（交集查询）

**请求**：`GET /api/external/statistics?userId=123,456&botId=bot1,bot2`

**SQL 逻辑**：`WHERE c.userId IN ('123', '456') AND c.botId IN ('bot1', 'bot2')`

**匹配的客户**：

- 客户 1 (userId=123, botId=bot1) ✅ 同时满足两个条件
- 客户 2 (userId=456, botId=bot1) ✅ 同时满足两个条件
- 客户 3 (userId=789, botId=bot2) ❌ userId 不匹配
- 客户 4 (userId=123, botId=bot3) ❌ botId 不匹配
- 客户 5 (userId=999, botId=bot1) ❌ userId 不匹配
- 客户 6 (userId=456, botId=bot2) ✅ 同时满足两个条件

**统计结果**：

- `viewing_count`: 5 (2+1+2)
- `completed_unpaid_count`: 1 (客户 1 的状态为 4)
- `completed_paid_count`: 2 (客户 2 和客户 6 的状态为 5)
- `total_commission`: 14000 (5000+3000+6000)

---

## 🎯 关键理解点

### 1. **OR vs AND 逻辑**

- **单个参数内部**：使用 OR 逻辑，匹配任一值

  ```sql
  userId IN ('123', '456', '789')  -- 匹配 123 或 456 或 789
  ```

- **多个参数之间**：使用 AND 逻辑，必须同时满足
  ```sql
  userId IN ('123', '456') AND botId IN ('bot1', 'bot2')
  -- 必须同时满足 userId 条件和 botId 条件
  ```

### 2. **集合运算理解**

当同时提供 `userId` 和 `botId` 时，实际上是查找两个集合的交集：

```
userId集合: {123, 456}
botId集合: {bot1, bot2}

交集结果: {客户1, 客户2, 客户6} (同时属于两个集合的客户)
```

### 3. **实际业务意义**

- **单参数筛选**：适合按客户来源或托管方分别统计
- **双参数筛选**：适合精确定位特定客户群体，减少数据范围

---

## 🔧 代码实现逻辑

### 参数解析

```typescript
// 解析批量参数
function parseBatchParams(param: string | null): string[] {
  if (!param) return [];
  return param
    .split(",")
    .map((id) => id.trim())
    .filter((id) => id.length > 0);
}

// 示例：userId=123,456,789
// 结果：['123', '456', '789']
```

### SQL 构建逻辑

```typescript
// 单参数筛选
if (hasUserFilter && !hasBotFilter) {
  // 只有 userId 筛选
  query += ` AND c.userId IN (${userIds.map(() => "?").join(",")})`;
  params.push(...userIds);
}

// 双参数筛选
if (hasUserFilter && hasBotFilter) {
  // 同时有 userId 和 botId 筛选（交集逻辑）
  query += ` AND c.userId IN (${userIds
    .map(() => "?")
    .join(",")}) AND c.botId IN (${botIds.map(() => "?").join(",")})`;
  params.push(...userIds, ...botIds);
}
```

---

## 📝 使用建议

### 1. **性能考虑**

- 单个参数筛选通常返回更多数据，查询性能较好
- 双参数筛选返回数据较少，但查询复杂度稍高

### 2. **业务场景**

- **单参数**：适合大范围统计，如"所有来自某个渠道的客户"
- **双参数**：适合精确统计，如"某个渠道下某个托管的客户"

### 3. **数据准确性**

- 双参数筛选能提供更精确的数据范围
- 单参数筛选可能包含不相关的数据

---

## 🎯 总结

多参数筛选逻辑的核心是：

1. **单参数**：OR 逻辑，匹配任一值
2. **双参数**：AND 逻辑，必须同时满足两个条件
3. **多值**：每个参数内部使用 OR，参数之间使用 AND

这种设计既保证了查询的灵活性，又提供了精确筛选的能力，能够满足不同业务场景的需求。
